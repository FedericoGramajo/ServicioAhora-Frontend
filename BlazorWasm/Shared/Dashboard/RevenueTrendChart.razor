@using System.Globalization

<div class="chart-container" style="height: 180px; position: relative;">
    <svg viewBox="0 0 100 50" preserveAspectRatio="none" style="width: 100%; height: 100%; overflow: visible;">
        <defs>
            <linearGradient id="areaGradient" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="#0d6efd" stop-opacity="0.2" />
                <stop offset="100%" stop-color="#0d6efd" stop-opacity="0" />
            </linearGradient>
        </defs>

        <!-- Grid lines -->
        <line x1="0" y1="45" x2="100" y2="45" stroke="#f0f0f0" stroke-width="0.5" />
        <line x1="0" y1="25" x2="100" y2="25" stroke="#f0f0f0" stroke-width="0.5" />
        <line x1="0" y1="5" x2="100" y2="5" stroke="#f0f0f0" stroke-width="0.5" />

        <!-- Area -->
        @if (Data.Count() > 1)
        {
            <path d="@AreaPath" fill="url(#areaGradient)" />
        }

        <!-- Path -->
        <polyline fill="none" stroke="#0d6efd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" points="@LinePoints" />
        
        <!-- Dots -->
        @foreach(var point in Dots)
        {
            <circle cx="@point.X" cy="@point.Y" r="2" fill="#0d6efd" stroke="white" stroke-width="1" />
        }
    </svg>
</div>
<div class="d-flex justify-content-between mt-3 text-muted" style="font-size: 0.75rem;">
    @foreach(var label in Labels)
    {
        <span>@label</span>
    }
</div>

@code {
    [Parameter] public IEnumerable<(string Label, decimal Value)> Data { get; set; } = Enumerable.Empty<(string, decimal)>();

    private string LinePoints
    {
        get
        {
            var list = Data.ToList();
            if (!list.Any()) return "";
            
            var max = list.Max(d => d.Value) * 1.2m;
            if (max == 0) max = 1;

            var points = new List<string>();
            decimal stepX = list.Count > 1 ? 100m / (list.Count - 1) : 0;

            for (int i = 0; i < list.Count; i++)
            {
                var x = list.Count > 1 ? i * stepX : 50;
                var y = 50 - (list[i].Value / max * 45) - 2; // Offset from bottom
                points.Add($"{x.ToString(CultureInfo.InvariantCulture)},{y.ToString(CultureInfo.InvariantCulture)}");
            }
            return string.Join(" ", points);
        }
    }

    private string AreaPath
    {
        get
        {
            var points = LinePoints;
            if (string.IsNullOrEmpty(points)) return "";
            
            var list = Data.ToList();
            if (list.Count <= 1) return "";

            return $"M 0 50 L {points} L 100 50 Z";
        }
    }
    
    private List<(string X, string Y)> Dots
    {
        get
        {
            var list = Data.ToList();
            if (!list.Any()) return new();

            var max = list.Max(d => d.Value) * 1.2m;
            if (max == 0) max = 1;
            
            var dots = new List<(string, string)>();
            decimal stepX = list.Count > 1 ? 100m / (list.Count - 1) : 0;

             for (int i = 0; i < list.Count; i++)
            {
                var x = list.Count > 1 ? i * stepX : 50;
                var y = 50 - (list[i].Value / max * 45) - 2;
                dots.Add((x.ToString(CultureInfo.InvariantCulture), y.ToString(CultureInfo.InvariantCulture)));
            }
            return dots;
        }
    }

    private IEnumerable<string> Labels => Data.Select(x => x.Label);
}
