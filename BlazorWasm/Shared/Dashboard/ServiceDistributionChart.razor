@using System.Globalization

<div class="d-flex align-items-center gap-4 flex-wrap">
    <!-- Donut Chart via conic-gradient -->
    <div class="position-relative flex-shrink-0" style="width: 140px; height: 140px;">
        @if (Data.Any() && TotalCount > 0)
        {
            <div style="width: 100%; height: 100%; border-radius: 50%; background: @CategoryGradient;"></div>
            <div class="position-absolute top-50 start-50 translate-middle bg-white rounded-circle d-flex align-items-center justify-content-center" style="width: 56%; height: 56%;">
                <span class="small fw-bold text-muted">@TotalCount</span>
            </div>
        }
        else
        {
            <div style="width: 100%; height: 100%; border-radius: 50%; background: #e9ecef;"></div>
            <div class="position-absolute top-50 start-50 translate-middle rounded-circle bg-white d-flex align-items-center justify-content-center" style="width: 56%; height: 56%;">
                <span class="small text-muted">0</span>
            </div>
        }
    </div>

    <!-- Legend -->
    <div class="flex-grow-1" style="min-width: 180px;">
        @{ var colors = new[] { "#0d6efd", "#198754", "#ffc107", "#dc3545", "#6c757d", "#6610f2", "#fd7e14" }; }
        @for (int i = 0; i < Segments.Count; i++)
        {
            var segment = Segments[i];
            var color = colors[i % colors.Length];
            <div class="d-flex align-items-center justify-content-between mb-2 small">
                <div class="d-flex align-items-center">
                    <span class="d-inline-block rounded-circle me-2 flex-shrink-0" style="width: 10px; height: 10px; background-color: @color;"></span>
                    <span class="text-truncate" title="@segment.Label">@segment.Label</span>
                </div>
                <span class="fw-bold ms-2">@segment.Percentage.ToString("0.0")%</span>
            </div>
        }
    </div>
</div>

@code {
    [Parameter] public IEnumerable<(string Category, int Count)> Data { get; set; } = Enumerable.Empty<(string, int)>();

    private int TotalCount => Data.Sum(x => x.Count);

    private List<DoughnutSegment> Segments
    {
        get
        {
            var list = Data.ToList();
            if (TotalCount == 0) return new List<DoughnutSegment>();

            var segments = new List<DoughnutSegment>();
            for (int i = 0; i < list.Count; i++)
            {
                var percentage = (double)list[i].Count / TotalCount * 100;
                segments.Add(new DoughnutSegment(list[i].Category, percentage));
            }
            return segments;
        }
    }

    private string CategoryGradient
    {
        get
        {
            if (TotalCount == 0) return "#e9ecef";
            var colors = new[] { "#0d6efd", "#198754", "#ffc107", "#dc3545", "#6c757d", "#6610f2", "#fd7e14" };
            var parts = new List<string>();
            double cum = 0;
            for (int i = 0; i < Segments.Count; i++)
            {
                var color = colors[i % colors.Length];
                parts.Add($"{color} {cum.ToString("0.00", CultureInfo.InvariantCulture)}% {(cum + Segments[i].Percentage).ToString("0.00", CultureInfo.InvariantCulture)}%");
                cum += Segments[i].Percentage;
            }
            return $"conic-gradient({string.Join(", ", parts)})";
        }
    }

    private record DoughnutSegment(string Label, double Percentage);
}
