@using ClientLibrary.Models.ServicioAhora.ServOffering
@using ClientLibrary.Models.Landing
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject IProfessionalDashboardService DashboardService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthStateProvider

<div class="surface-card">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-3">
        <div>
            <h4 class="mb-1">Servicios por rubro</h4>
            <p class="text-muted mb-0">Mostrando tus publicaciones por categoría</p>
        </div>
    </div>
    @if (MyServices == null)
    {
        <p>Cargando servicios...</p>
    }
    else
    {
        var groupedServices = MyServices.GroupBy(s => s.CategoryName).ToList();
        
        @foreach (var group in groupedServices)
        {
            var firstService = group.FirstOrDefault();
            var categoryId = firstService?.CategoryId ?? Guid.Empty;

            <div class="service-group mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                    <div>
                        <h5 class="mb-0">@group.Key</h5>
                        <small class="text-secondary">@group.Count() servicio(s)</small>
                    </div>
                    <button class="btn btn-primary btn-sm" @onclick="() => OpenAddServiceModal(group.Key, categoryId)">
                        <i class="fa-solid fa-plus me-1"></i> Agregar servicio
                    </button>
                </div>
                <div class="row g-3">
                    @foreach (var service in group)
                    {
                        <div class="col-md-4">
                            <ProfessionalServiceCard 
                                Service="@service" 
                                Category="@group.Key"
                                OnEdit="@((s) => EditService(s, group.Key))"
                                OnDelete="DeleteService" />
                        </div>
                    }
                </div>
            </div>
        }
        
        @if (!groupedServices.Any())
        {
             <div class="alert alert-info">
                No tienes servicios creados.
             </div>
        }
    }
</div>

@if (showAddServiceModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(isEditingService ? "Editar servicio" : "Publicar nuevo servicio")</h5>
                    <button type="button" class="btn-close" @onclick="CloseAddServiceModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre del servicio</label>
                        <input type="text" class="form-control" @bind="newService.Name" placeholder="Ej. Limpieza de tapizados" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rubro</label>
                        <input type="text" class="form-control" value="@newService.Category" disabled readonly />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Precio estimado</label>
                        <input type="number" class="form-control" @bind="newService.Price" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Imagen del servicio</label>
                        <InputFile OnChange="HandleImageUpload" class="form-control" accept="image/*" />
                        @if (!string.IsNullOrEmpty(newService.Image))
                        {
                            <div class="mt-2 text-center">
                                <img src="@newService.Image" alt="Vista previa" class="img-thumbnail" style="max-height: 200px;" />
                            </div>
                        }
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción</label>
                        <textarea class="form-control" rows="3" @bind="newService.Description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAddServiceModal" disabled="@IsLoading">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveService" disabled="@IsLoading">
                        @(IsLoading ? "Procesando..." : (isEditingService ? "Guardar Cambios" : "Publicar"))
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public List<GetServiceOffering> MyServices { get; set; } = new();
    [Parameter] public EventCallback OnServiceChanged { get; set; }

    private bool showAddServiceModal = false;
    private ServiceFormModel newService = new();
    private bool isEditingService = false;
    private bool IsLoading = false;
    private Guid selectedCategoryId;

    private async Task HandleImageUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try
            {
                var resizedFile = await file.RequestImageFileAsync(file.ContentType, 600, 400);
                var buffer = new byte[resizedFile.Size];
                await resizedFile.OpenReadStream().ReadAsync(buffer);
                var base64 = Convert.ToBase64String(buffer);
                newService.Image = $"data:{file.ContentType};base64,{base64}";
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error uploading image: {ex.Message}");
                await JS.ToastrError("Error al procesar la imagen.");
            }
        }
    }

    public void OpenAddServiceModal(string? categoryName = null, Guid? categoryId = null, GetServiceOffering? serviceToEdit = null)
    {
        if (serviceToEdit != null)
        {
            isEditingService = true;
            newService = new ServiceFormModel
            {
                Slug = serviceToEdit.Id.ToString(), 
                Name = serviceToEdit.Name,
                Category = categoryName ?? serviceToEdit.CategoryName,
                Price = serviceToEdit.BasePrice,
                Description = serviceToEdit.Description ?? "",
                Image = serviceToEdit.Image
            };
            selectedCategoryId = serviceToEdit.CategoryId;
        }
        else
        {
            isEditingService = false;
            newService = new(); 
            if (!string.IsNullOrEmpty(categoryName))
            {
                newService.Category = categoryName;
            }
            selectedCategoryId = categoryId ?? Guid.Empty;
        }
        showAddServiceModal = true;
    }

    private void CloseAddServiceModal()
    {
        showAddServiceModal = false;
    }

    private async Task SaveService()
    {
        IsLoading = true;
        try
        {
            if (isEditingService)
            {
                 await DashboardService.UpdateServiceAsync(newService);
                 await JS.ToastrSuccess("Servicio actualizado correctamente.");
            }
            else
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                // Try to find sub claim or nameidentifier
                var professionalId = user.FindFirst(c => c.Type == ClaimTypes.NameIdentifier)?.Value 
                                     ?? user.FindFirst("sub")?.Value;

                if (string.IsNullOrEmpty(professionalId))
                {
                     await JS.ToastrError("No se pudo identificar al profesional.");
                     return;
                }

                var createModel = new CreateServiceOffering
                {
                    Name = newService.Name,
                    Description = newService.Description,
                    BasePrice = newService.Price,
                    Image = newService.Image,
                    CategoryId = selectedCategoryId,
                    ProfessionalId = professionalId,
                    Status = true,
                    EstimatedDuration = 1 // Default duration or add field
                };

                await DashboardService.AddServiceAsync(createModel);
                await JS.ToastrSuccess("Servicio publicado correctamente.");
            }
            
            showAddServiceModal = false;
            await OnServiceChanged.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            await JS.ToastrError("Error al guardar el servicio.");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void EditService(GetServiceOffering service, string categoryName)
    {
        OpenAddServiceModal(categoryName, service.CategoryId, service);
    }

    private async Task DeleteService(GetServiceOffering service)
    {
         await DashboardService.DeleteServiceAsync(service.Id.ToString());
         await JS.ToastrSuccess("Servicio eliminado.");
         await OnServiceChanged.InvokeAsync();
    }
}
