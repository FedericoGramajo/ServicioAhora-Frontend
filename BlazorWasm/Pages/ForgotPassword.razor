@page "/forgot-password"
@using System.ComponentModel.DataAnnotations
@using ClientLibrary.Models
@inject HttpClient Http

<PageTitle>Recuperar contraseña - ServicioAhora!</PageTitle>

<section class="auth-page py-5 py-lg-6">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-7 col-xl-6">
                <div class="card auth-card shadow-lg border-0">
                    <div class="card-body p-4 p-lg-5">
                        <div class="text-center mb-4">
                            <a class="auth-brand d-inline-flex align-items-center" href="/">
                                <i class="fa-solid fa-house-chimney me-2"></i>
                                <span class="fw-bold">ServicioAhora!</span>
                            </a>
                            <p class="text-muted mb-0">Te enviamos un enlace para restablecer tu contraseña.</p>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(Message))
                        {
                            <div class="alert alert-@AlertClass" role="alert">@Message</div>
                        }

                        <EditForm Model="Model" OnValidSubmit="SendResetLink">
                            <DataAnnotationsValidator />
                            <div class="mb-3">
                                <label class="form-label fw-semibold" for="forgotEmail">Correo electrónico</label>
                                <InputText id="forgotEmail" class="form-control" @bind-Value="Model.Email" placeholder="tu@email.com" />
                                <ValidationMessage For="() => Model.Email" />
                            </div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg">Enviar enlace</button>
                                <a class="btn btn-outline-primary" href="/login">Volver a iniciar sesión</a>
                                <a class="btn btn-link" href="/">Volver al inicio</a>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@code {
    private ForgotPasswordModel Model { get; } = new();
    private string Message { get; set; } = string.Empty;
    private string AlertClass { get; set; } = "info";

    private async Task SendResetLink()
    {
        Message = string.Empty;
        AlertClass = "info";

        var response = await Http.PostAsJsonAsync("authentication/forgot-password", Model);
        if (!response.IsSuccessStatusCode)
        {
            AlertClass = "danger";
            Message = "No pudimos enviar el enlace. Intentá nuevamente.";
            return;
        }

        var result = await response.Content.ReadFromJsonAsync<ServiceResponse>();
        if (result is null)
        {
            AlertClass = "danger";
            Message = "No pudimos enviar el enlace. Intentá nuevamente.";
            return;
        }

        AlertClass = result.success ? "success" : "danger";
        Message = string.IsNullOrWhiteSpace(result.Message)
            ? "Si el correo existe, te enviaremos un enlace en minutos."
            : result.Message;
    }

    private sealed class ForgotPasswordModel
    {
        [Required(ErrorMessage = "Ingresá tu correo electrónico.")]
        [EmailAddress(ErrorMessage = "Ingresá un correo válido.")]
        public string Email { get; set; } = string.Empty;
    }
}
