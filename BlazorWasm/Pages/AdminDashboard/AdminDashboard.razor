@attribute [Route(RouteConstants.AdminDashboard)]
@attribute [Authorize(Roles = Constant.Administration.AdminRole)]
@using ClientLibrary.Helper
@using ClientLibrary.Models.Landing
@using ClientLibrary.Models.Authentication.Rol.Professional
@using ClientLibrary.Services.Contracts
@inject IJSRuntime js
@inject IAdminDashboardService dashboardService
@inject ICategoryService categoryService
@inject IServOfferingService servOfferingService

<PageTitle>Panel administrador - ServicioAhora!</PageTitle>

<div class="landing-page">
    <main class="container py-5 account-layout">
        <div class="section-heading flex-column flex-lg-row">
            <div>
                <p class="text-uppercase text-muted small mb-1">Administración</p>
                <h2 class="mb-0">Control general de rubros, servicios y profesionales</h2>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary">Descargar reportes</button>
                @* <button class="btn btn-primary">Crear registro</button> *@
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "resume" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "resume"'>
                    <i class="fa-solid fa-chart-line me-2"></i>Resumen
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "categories" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "categories"'>
                    <i class="fa-solid fa-layer-group me-2"></i>Rubros
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "services" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "services"'>
                    <i class="fa-solid fa-briefcase me-2"></i>Servicios
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "professionals" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "professionals"'>
                    <i class="fa-solid fa-user-tie me-2"></i>Profesionales
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "bookings" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "bookings"'>
                    <i class="fa-solid fa-calendar-check me-2"></i>Reservas
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link @(ActiveTab == "audit" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "audit"'>
                    <i class="fa-solid fa-shield-halved me-2"></i>Auditoría
                </button>
            </li>
        </ul>

        <!-- Content -->
        @if (isLoading)
        {
            <div class="row g-3 mb-4">
                <div class="col-md-3"><LoadingSkeleton Height="100" /></div>
                <div class="col-md-3"><LoadingSkeleton Height="100" /></div>
                <div class="col-md-3"><LoadingSkeleton Height="100" /></div>
                <div class="col-md-3"><LoadingSkeleton Height="100" /></div>
            </div>
            <LoadingSkeleton Height="500" />
        }
        else if (ActiveTab == "resume")
        {
            <AdminAdvancedReports />
        }
        else if (ActiveTab == "categories")
        {
            <AdminCategoryManager Categories="Categories" OnCategoryChanged="LoadCategories" />
        }
        else if (ActiveTab == "services")
        {
             <ServiceTableSection Categories="Categories"
                                  Services="Services"
                                  Professionals="Professionals"
                                  LocalCulture="LocalCulture"
                                  OnServiceChanged="LoadServices" />
        }
        else if (ActiveTab == "professionals")
        {
            <ProfessionalTableSection Professionals="Professionals" />
        }
        else if (ActiveTab == "bookings")
        {
             <AdminBookingManager />
        }
        else if (ActiveTab == "audit")
        {
            <AuditLogSection />
        }

    </main>
</div>

@code {
    private readonly CultureInfo LocalCulture = new("es-AR");

    // Tab State
    private string ActiveTab { get; set; } = "resume";
    private bool isLoading = true;

    [Parameter]
    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    private List<GetCategory> Categories { get; set; } = new();
    private List<GetServiceOffering> Services { get; set; } = new();
    private List<GetProfessional> Professionals { get; set; } = new();
    private List<AdminMetric> SummaryMetrics { get; set; } = new();
    private List<ServiceTransaction> Transactions { get; set; } = new();
    private List<ReportBar> CategoryReportData { get; set; } = new();
    private List<ReportBar> StatusReportData { get; set; } = new();

    private int CategoryMax => CategoryReportData.Any() ? CategoryReportData.Max(r => r.Count) : 0;
    private int StatusMax => StatusReportData.Any() ? StatusReportData.Max(r => r.Count) : 0;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Tab))
        {
            ActiveTab = Tab.ToLower() switch
            {
                "categories" => "categories",
                "services" => "services",
                "professionals" => "professionals",
                "bookings" => "bookings",
                "audit" => "audit",
                _ => "resume"
            };
        }
        await LoadAllData();
    }

    private async Task LoadAllData()
    {
        isLoading = true;
        try 
        {
            // Sequential loading to avoid overwhelming WASM and ensure tokens are refreshed if needed
            await LoadCategories();
            await LoadServices();
            await LoadMetrics();
            await LoadReports();
            await LoadProfessionals();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCategories()
    {
        var categories = await categoryService.GetAllAsync();
        Categories = categories?.ToList() ?? new List<GetCategory>();
    }
    private async Task LoadServices()
    {
        var servOffering = await servOfferingService.GetAllAsync();
        Services = servOffering?.ToList() ?? new List<GetServiceOffering>();
    }

    private async Task LoadMetrics()
    {
        var metrics = await dashboardService.GetMetricsAsync();
        SummaryMetrics = new List<AdminMetric>
        {
            new AdminMetric("Servicios Activos", metrics.ActiveServices.ToString(), "Servicios publicados"),
            new AdminMetric("Nuevas Solicitudes", metrics.NewRequests.ToString(), "Pendientes de atención"),
            new AdminMetric("En Curso", metrics.InProgress.ToString(), "Servicios ejecutándose"),
            new AdminMetric("Nuevos Profesionales", metrics.NewProfessionals.ToString(), "Registrados recientemente")
        };
    }

    private async Task LoadReports()
    {
        // Default to last 6 months as requested
        var start = DateTime.Now.AddMonths(-6);
        var end = DateTime.Now;
        
        var result = await dashboardService.GetTransactionsAsync(start, end);
        Transactions = result ?? new List<ServiceTransaction>();
        
        if (Transactions.Any())
        {
            // Group by Category
            CategoryReportData = Transactions
                .GroupBy(t => t.Category)
                .Select(g => new ReportBar(g.Key, g.Count()))
                .OrderByDescending(r => r.Count)
                .ToList();
            // Group by Status
            StatusReportData = Transactions
                .GroupBy(t => t.Status)
                .Select(g => new ReportBar(g.Key, g.Count()))
                .OrderByDescending(r => r.Count)
                .ToList();
        }
    }

    private async Task LoadProfessionals()
    {
        var professionals = await dashboardService.GetProfessionalsAsync();
        Professionals = professionals?.ToList() ?? new List<GetProfessional>();
    }

}
