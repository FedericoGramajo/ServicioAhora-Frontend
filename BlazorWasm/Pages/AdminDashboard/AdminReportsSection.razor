@using ClientLibrary.Models.Landing
@using ClientLibrary.Models.Category
@using System.Globalization
@using ClientLibrary.Services.Contracts
@inject IDashboardService DashboardService

<section class="admin-reports">
    <header class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
        <div>
            <h2 class="h4 mb-1 fw-bold">Reportes consolidados</h2>
            <p class="text-muted mb-0">Análisis detallado de actividad, rubros y estados</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <div class="input-group input-group-sm" style="width: auto;">
                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-calendar-days text-primary"></i></span>
                <select class="form-select border-start-0 ps-0 shadow-none" @bind="SelectedPeriod" aria-label="Seleccionar periodo">
                    <option value="7">Últimos 7 días</option>
                    <option value="30">Últimos 30 días</option>
                    <option value="365">Últimos 12 meses</option>
                </select>
            </div>
            <button class="btn btn-primary btn-sm px-3 shadow-sm" type="button">
                <i class="fa-solid fa-rotate me-2"></i>Actualizar
            </button>
        </div>
    </header>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        @foreach (var metric in SummaryMetrics)
        {
            var config = GetMetricConfig(metric.Label);
            <div class="col-sm-6 col-xl-3">
                <article class="stat-card p-3 h-100 shadow-sm surface-card border-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted small fw-semibold mb-1 text-uppercase ls-wide">@metric.Label</p>
                            <h3 class="h2 mb-1 fw-bold">@metric.Value</h3>
                            <p class="mb-0 small text-muted">@metric.Subtitle</p>
                        </div>
                        <div class="stat-icon p-2 rounded-3" style="background-color: @(config.Color)15; color: @config.Color;">
                            <i class="fa-solid @config.Icon fs-4"></i>
                        </div>
                    </div>
                </article>
            </div>
        }
    </div>

    <!-- Charts Main Layout -->
    <div class="row g-4 mb-4">
        <!-- Activity Evolution -->
        <article class="col-lg-7">
            <div class="bar-chart-card h-100 p-4 shadow-sm border-0">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="h6 mb-1 fw-bold text-dark">Evolución de Órdenes</h3>
                        <p class="text-muted small mb-0">Cantidad de servicios solicitados por mes</p>
                    </div>
                    @if (TrendData.Count > 1)
                    {
                        var diff = TrendData.Last().Value - TrendData.First().Value;
                        var colorClass = diff >= 0 ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger";
                        <div class="badge @colorClass px-2 py-1">
                            <i class="fa-solid @(diff >= 0 ? "fa-arrow-trend-up" : "fa-arrow-trend-down") me-1"></i> 
                            @(diff >= 0 ? "+" : "")@diff
                        </div>
                    }
                </div>
                
                <div class="chart-wrapper position-relative" style="height: 220px;">
                    <svg viewBox="0 0 100 50" preserveAspectRatio="none" style="width: 100%; height: 100%; overflow: visible;" aria-label="Gráfico de tendencia de actividad">
                        <defs>
                            <linearGradient id="trendGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="#0d6efd" stop-opacity="0.15" />
                                <stop offset="100%" stop-color="#0d6efd" stop-opacity="0" />
                            </linearGradient>
                        </defs>
                        <!-- Grid lines and labels -->
                        <g class="grid-lines">
                            <line x1="0" y1="45" x2="100" y2="45" stroke="#f0f0f0" stroke-width="0.5" />
                            <text x="-2" y="46" text-anchor="end" font-size="3" fill="#999">0</text>
                            
                            <line x1="0" y1="25" x2="100" y2="25" stroke="#f0f0f0" stroke-width="0.5" />
                            <text x="-2" y="26" text-anchor="end" font-size="3" fill="#999">@MidTrendValue</text>
                            
                            <line x1="0" y1="5" x2="100" y2="5" stroke="#f0f0f0" stroke-width="0.5" />
                            <text x="-2" y="6" text-anchor="end" font-size="3" fill="#999">@MaxTrendValue</text>
                        </g>

                        <!-- Y-Axis Title -->
                        <text x="-12" y="25" text-anchor="middle" font-size="3" fill="#666" transform="rotate(-90, -12, 25)">Órdenes</text>

                        <!-- Area -->
                        <path d="@TrendAreaPath" fill="url(#trendGradient)" />

                        <!-- Line -->
                        <path d="@TrendLinePath" fill="none" stroke="#0d6efd" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        
                        <!-- Intersections & Values -->
                        @for (int i = 0; i < TrendDots.Count; i++)
                        {
                            var point = TrendDots[i];
                            var val = TrendData[i].Value;
                            <g class="chart-point">
                                <circle cx="@point.X" cy="@point.Y" r="2" fill="#0d6efd" stroke="#fff" stroke-width="1" />
                                <text x="@point.X" y="@((decimal.Parse(point.Y, CultureInfo.InvariantCulture) - 3).ToString(CultureInfo.InvariantCulture))" 
                                      text-anchor="middle" font-size="3.5" font-weight="bold" fill="#0d6efd">@val</text>
                            </g>
                        }
                    </svg>
                </div>
                <div class="d-flex justify-content-between mt-3 px-1 text-muted fw-medium" style="font-size: 0.7rem;">
                    @foreach(var item in TrendData)
                    {
                        <span>@item.Label</span>
                    }
                </div>
            </div>
        </article>

        <!-- Categories Distribution -->
@*         <article class="col-lg-5">
            <div class="bar-chart-card h-100 p-4 shadow-sm border-0">
                <header class="mb-4">
                    <h3 class="h6 mb-1 fw-bold text-dark">Distribución por rubros</h3>
                    <p class="text-muted small mb-0">Análisis porcentual por categorías</p>
                </header>

                <div class="d-flex flex-column align-items-center gap-4">
                    <!-- Donut Chart via conic-gradient -->
                    <div class="position-relative flex-shrink-0" style="width: 160px; height: 160px;">
                        @if (DoughnutSegments.Any())
                        {
                            <div style="width: 100%; height: 100%; border-radius: 50%; background: @CategoryGradient;" role="img" aria-label="Distribución de rubros"></div>
                            <div class="position-absolute top-50 start-50 translate-middle bg-white rounded-circle shadow-sm d-flex flex-column align-items-center justify-content-center" style="width: 58%; height: 58%;">
                                <span class="fw-bold h4 mb-0">@CategoryReportData.Sum(x => x.Count)</span>
                                <span class="text-muted" style="font-size: 0.6rem; text-uppercase; letter-spacing: 0.5px;">Órdenes</span>
                            </div>
                        }
                        else
                        {
                            <div style="width: 100%; height: 100%; border-radius: 50%; background: #f8f9fa;"></div>
                        }
                    </div>

                    <!-- Legend -->
                    <div class="w-100 mt-2 overflow-auto" style="max-height: 200px;">
                        @foreach (var segment in DoughnutSegments)
                        {
                            <div class="d-flex align-items-center justify-content-between mb-2 pb-2 border-bottom border-light last-border-0">
                                <div class="d-flex align-items-center gap-2 overflow-hidden">
                                    <span class="d-inline-block rounded-circle flex-shrink-0" style="width: 12px; height: 12px; background-color: @segment.Color;"></span>
                                    <span class="small fw-medium text-truncate">@segment.Label</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="small fw-bold text-dark">@segment.Percentage.ToString("0.0")%</span>
                                    <span class="badge bg-light text-muted fw-normal" style="font-size: 0.65rem;">@segment.Count</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </article>*@
    </div> 
    
    <!-- Status Progress -->

    @if (IsLoadingReports)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando reportes detallados...</span>
            </div>
        </div>
    }
    else
    {
        <!-- Advanced Finacial Summary -->
        <article class="surface-card p-4 shadow-sm border-0 mb-4 bg-gradient-finance">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h3 class="h5 fw-bold text-white mb-1">Recaudación Total</h3>
                    <p class="text-white-50 small mb-0">Basado en servicios completados exitosamente</p>
                    <h2 class="display-5 fw-bold text-white mt-2 mb-0">@DetailedReports.TotalRevenue.ToString("C0", CultureInfo.GetCultureInfo("es-AR"))</h2>
                </div>
            </div>
        </article>

        <div class="row g-4 mb-4">
            <!-- Growth Chart -->
            <article class="col-lg-6">
                <div class="surface-card p-4 shadow-sm border-0 h-100">
                    <h3 class="h6 mb-3 fw-bold text-dark"><i class="fa-solid fa-chart-line text-primary me-2"></i>Crecimiento de Usuarios</h3>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Mes</th>
                                    <th class="text-center">Clientes</th>
                                    <th class="text-center">Profesionales</th>
                                    <th class="text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in DetailedReports.UserGrowth)
                                {
                                    <tr>
                                        <td class="fw-medium">@item.Month</td>
                                        <td class="text-center">@item.CustomerCount</td>
                                        <td class="text-center">@item.ProfessionalCount</td>
                                        <td class="text-center fw-bold text-primary">@(item.CustomerCount + item.ProfessionalCount)</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>

            <!-- Balance vs Categories -->
            <article class="col-lg-6">
                <div class="surface-card p-4 shadow-sm border-0 h-100">
                    <h3 class="h6 mb-3 fw-bold text-dark"><i class="fa-solid fa-scale-balanced text-warning me-2"></i>Balance de Categorías</h3>
                    <div class="table-responsive">
                        <table class="table table-sm table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Rubro</th>
                                    <th class="text-center">Pedidos</th>
                                    <th class="text-center">Profesionales</th>
                                    <th class="text-center">Ratio P/P</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in DetailedReports.CategoryBalance)
                                {
                                    <tr>
                                        <td class="fw-medium text-truncate" style="max-width: 150px;">@item.CategoryName</td>
                                        <td class="text-center">@item.RequestCount</td>
                                        <td class="text-center">@item.ProfessionalCount</td>
                                        <td class="text-center">
                                            @{
                                                var ratio = item.ProfessionalCount > 0 ? (double)item.RequestCount / item.ProfessionalCount : item.RequestCount;
                                                var badgeColor = ratio > 5 ? "bg-danger" : ratio > 2 ? "bg-warning text-dark" : "bg-success";
                                            }
                                            <span class="badge @badgeColor">@ratio.ToString("N1")</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </article>
        </div>

        <!-- Audit Summary (Expanded) -->
        <article class="surface-card p-4 shadow-sm border-0 mb-4">
             <div class="row items-center mb-3">
                <div class="col-8">
                    <h3 class="h6 mb-0 fw-bold text-dark"><i class="fa-solid fa-user-shield text-danger me-2"></i>Resumen de Acciones de Sistema</h3>
                </div>
                <div class="col-4 text-end">
                     <span class="badge bg-light text-muted fw-normal">Histórico</span>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="bg-light">
                        <tr class="small text-uppercase text-muted">
                            <th>Acción</th>
                            <th class="text-center">Frecuencia</th>
                            <th class="text-end">Impacto</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var audit in DetailedReports.AuditSummary)
                        {
                            <tr>
                                <td class="fw-medium">@audit.Action</td>
                                <td class="text-center fw-bold text-primary">@audit.Count.ToString("N0")</td>
                                <td class="text-end">
                                    <div class="progress" style="height: 6px; width: 100px; display: inline-flex;">
                                        @{
                                            var maxAudit = DetailedReports.AuditSummary.Max(x => x.Count);
                                            var pct = maxAudit > 0 ? (double)audit.Count / maxAudit * 100 : 0;
                                        }
                                        <div class="progress-bar bg-primary" style="width: @pct.ToString("F0")%"></div>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </article>
    }
</section>

<style>
    .admin-reports .stat-card {
        border-radius: 16px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .admin-reports .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.05) !important;
    }
    .admin-reports .ls-wide { letter-spacing: 0.05em; }
    .admin-reports .last-border-0:last-child { border-bottom: 0 !important; }
    .admin-reports .bar-chart-card { border-radius: 20px; }
    .bg-gradient-finance {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        border-radius: 20px;
    }
    .border-white-10 { border-color: rgba(255,255,255,0.1) !important; }
    .fs-small { font-size: 0.75rem; }
    .btn-xs { padding: 0.1rem 0.4rem; font-size: 0.75rem; }
</style>

@code {
    [Parameter] public IEnumerable<GetCategory> Categories { get; set; } = Enumerable.Empty<GetCategory>();
    [Parameter] public List<AdminMetric> SummaryMetrics { get; set; } = new();
    [Parameter] public List<ServiceTransaction> Transactions { get; set; } = new();
    [Parameter] public IEnumerable<ReportBar> CategoryReportData { get; set; } = Enumerable.Empty<ReportBar>();
    [Parameter] public IEnumerable<ReportBar> StatusReportData { get; set; } = Enumerable.Empty<ReportBar>();
    [Parameter] public int CategoryMax { get; set; }
    [Parameter] public int StatusMax { get; set; }

    private ClientLibrary.Models.Dashboard.AdminReportsResponse DetailedReports { get; set; } = new();
    private bool IsLoadingReports { get; set; } = true;
    private string SelectedPeriod { get; set; } = "30";

    protected override async Task OnInitializedAsync()
    {
        await LoadDetailedReports();
    }

    private async Task LoadDetailedReports()
    {
        IsLoadingReports = true;
        try
        {
            var response = await DashboardService.GetAdminReportsAsync();
            if (response != null && response.success)
            {
                DetailedReports = response.Data ?? new();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading reports: {ex.Message}");
        }
        finally
        {
            IsLoadingReports = false;
        }
    }

    private (string Icon, string Color) GetMetricConfig(string label) => label switch
    {
        "Servicios Activos" => ("fa-bullhorn", "#198754"),
        "Nuevas Solicitudes" => ("fa-cart-plus", "#0d6efd"),
        "En Curso" => ("fa-spinner", "#0dcaf0"),
        "Nuevos Profesionales" => ("fa-user-tie", "#6610f2"),
        _ => ("fa-chart-line", "#6c757d")
    };

    // Chart Logic: Doughnut
    private List<DoughnutSegment> DoughnutSegments
    {
        get
        {
            var total = CategoryReportData.Sum(x => x.Count);
            if (total == 0) return new List<DoughnutSegment>();

            var segments = new List<DoughnutSegment>();
            var colors = new[] { "#0d6efd", "#198754", "#ffc107", "#dc3545", "#6c757d", "#6610f2", "#fd7e14" };
            var dataList = CategoryReportData.ToList();

            for (int i = 0; i < dataList.Count; i++)
            {
                var percentage = (double)dataList[i].Count / total * 100;
                segments.Add(new DoughnutSegment(
                    dataList[i].Label,
                    dataList[i].Count,
                    percentage,
                    colors[i % colors.Length]
                ));
            }
            return segments;
        }
    }

    private string CategoryGradient
    {
        get
        {
            var segments = DoughnutSegments;
            if (!segments.Any()) return "#f8f9fa";
            
            var parts = new List<string>();
            double cum = 0;
            foreach (var s in segments)
            {
                parts.Add($"{s.Color} {cum.ToString("0.00", CultureInfo.InvariantCulture)}% {(cum + s.Percentage).ToString("0.00", CultureInfo.InvariantCulture)}%");
                cum += s.Percentage;
            }
            return $"conic-gradient({string.Join(", ", parts)})";
        }
    }

    private record DoughnutSegment(string Label, int Count, double Percentage, string Color);

    // Dynamic Trend Data
    private List<(string Label, int Value)> TrendData => 
        Transactions.Any() 
            ? Transactions
                .GroupBy(t => t.Date.ToString("MMM", new CultureInfo("es-ES")))
                .OrderBy(g => g.Min(t => t.Date))
                .Select(g => (Label: char.ToUpper(g.Key[0]) + g.Key.Substring(1), Value: g.Count()))
                .ToList()
            : new() { ("Sin datos", 0) };

    private int MaxTrendValue => TrendData.Any() ? TrendData.Max(x => x.Value) : 0;
    private int MidTrendValue => MaxTrendValue / 2;

    private string TrendLinePath
    {
        get
        {
            var data = TrendData;
            if (data.Count == 0) return "M 0 45 L 100 45";
            
            var maxCount = data.Max(x => x.Value);
            
            if (data.Count == 1)
            {
                var y = CalculateY(data[0].Value, maxCount);
                return $"M 0 {y.ToString(CultureInfo.InvariantCulture)} L 100 {y.ToString(CultureInfo.InvariantCulture)}";
            }

            var points = new List<string>();
            decimal stepX = 100m / (data.Count - 1);

            for (int i = 0; i < data.Count; i++)
            {
                var x = i * stepX;
                var y = CalculateY(data[i].Value, maxCount);
                points.Add(i == 0 ? "M" : "L");
                points.Add($"{x.ToString(CultureInfo.InvariantCulture)} {y.ToString(CultureInfo.InvariantCulture)}");
            }
            return string.Join(" ", points);
        }
    }

    private decimal CalculateY(int value, int maxCount)
    {
        decimal chartMax = maxCount > 0 ? (decimal)maxCount * 1.2m : 10m;
        return 50m - ((decimal)value / chartMax * 40m) - 5m;
    }

    private string TrendAreaPath => TrendData.Count >= 2 ? $"{TrendLinePath} L 100 50 L 0 50 Z" : "M 0 50 L 100 50 Z";

    private List<(string X, string Y)> TrendDots
    {
        get
        {
            var data = TrendData;
            if (data.Count < 1) return new();
            
            var maxCount = data.Max(x => x.Value);
            var dots = new List<(string, string)>();
            decimal stepX = data.Count > 1 ? 100m / (data.Count - 1) : 0;

            for (int i = 0; i < data.Count; i++)
            {
                var x = i * stepX;
                var y = CalculateY(data[i].Value, maxCount);
                dots.Add((x.ToString(CultureInfo.InvariantCulture), y.ToString(CultureInfo.InvariantCulture)));
            }
            return dots;
        }
    }
}
