@using ClientLibrary.Models.Landing
@using ClientLibrary.Models.Category
@using System.Globalization

<section class="admin-reports">
    <header class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3 mb-4">
        <div>
            <h2 class="h4 mb-1 fw-bold">Reportes consolidados</h2>
            <p class="text-muted mb-0">Análisis detallado de actividad, rubros y estados</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <div class="input-group input-group-sm" style="width: auto;">
                <span class="input-group-text bg-white border-end-0"><i class="fa-solid fa-calendar-days text-primary"></i></span>
                <select class="form-select border-start-0 ps-0 shadow-none" @bind="SelectedPeriod" aria-label="Seleccionar periodo">
                    <option value="7">Últimos 7 días</option>
                    <option value="30">Últimos 30 días</option>
                    <option value="365">Últimos 12 meses</option>
                </select>
            </div>
            <button class="btn btn-primary btn-sm px-3 shadow-sm" type="button">
                <i class="fa-solid fa-rotate me-2"></i>Actualizar
            </button>
        </div>
    </header>

    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
        @foreach (var metric in SummaryMetrics)
        {
            var config = GetMetricConfig(metric.Label);
            <div class="col-sm-6 col-xl-3">
                <article class="stat-card p-3 h-100 shadow-sm surface-card border-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <p class="text-muted small fw-semibold mb-1 text-uppercase ls-wide">@metric.Label</p>
                            <h3 class="h2 mb-1 fw-bold">@metric.Value</h3>
                            <p class="mb-0 small text-muted">@metric.Subtitle</p>
                        </div>
                        <div class="stat-icon p-2 rounded-3" style="background-color: @(config.Color)15; color: @config.Color;">
                            <i class="fa-solid @config.Icon fs-4"></i>
                        </div>
                    </div>
                </article>
            </div>
        }
    </div>

    <!-- Charts Main Layout -->
    <div class="row g-4 mb-4">
        <!-- Activity Evolution -->
        <article class="col-lg-7">
            <div class="bar-chart-card h-100 p-4 shadow-sm border-0">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h3 class="h6 mb-1 fw-bold text-dark">Evolución de actividad</h3>
                        <p class="text-muted small mb-0">Volumen de órdenes histórico</p>
                    </div>
                    @if (TrendData.Count > 1)
                    {
                        var diff = TrendData.Last().Value - TrendData.First().Value;
                        var colorClass = diff >= 0 ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger";
                        <div class="badge @colorClass px-2 py-1">
                            <i class="fa-solid @(diff >= 0 ? "fa-arrow-trend-up" : "fa-arrow-trend-down") me-1"></i> 
                            @(diff >= 0 ? "+" : "")@diff
                        </div>
                    }
                </div>
                
                <div class="chart-wrapper position-relative" style="height: 220px;">
                    <svg viewBox="0 0 100 50" preserveAspectRatio="none" style="width: 100%; height: 100%; overflow: visible;" aria-label="Gráfico de tendencia de actividad">
                        <defs>
                            <linearGradient id="trendGradient" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stop-color="#0d6efd" stop-opacity="0.15" />
                                <stop offset="100%" stop-color="#0d6efd" stop-opacity="0" />
                            </linearGradient>
                        </defs>
                        <!-- Grid lines -->
                        <line x1="0" y1="45" x2="100" y2="45" stroke="#f0f0f0" stroke-width="0.5" />
                        <line x1="0" y1="25" x2="100" y2="25" stroke="#f0f0f0" stroke-width="0.5" />
                        <line x1="0" y1="5" x2="100" y2="5" stroke="#f0f0f0" stroke-width="0.5" />

                        <!-- Area -->
                        <path d="@TrendAreaPath" fill="url(#trendGradient)" />

                        <!-- Line -->
                        <path d="@TrendLinePath" fill="none" stroke="#0d6efd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        
                        <!-- Intersections -->
                        @foreach(var point in TrendDots)
                        {
                            <circle cx="@point.X" cy="@point.Y" r="2.5" fill="#0d6efd" stroke="#fff" stroke-width="1.5" />
                        }
                    </svg>
                </div>
                <div class="d-flex justify-content-between mt-3 px-1 text-muted fw-medium" style="font-size: 0.7rem;">
                    @foreach(var item in TrendData)
                    {
                        <span>@item.Label</span>
                    }
                </div>
            </div>
        </article>

        <!-- Categories Distribution -->
@*         <article class="col-lg-5">
            <div class="bar-chart-card h-100 p-4 shadow-sm border-0">
                <header class="mb-4">
                    <h3 class="h6 mb-1 fw-bold text-dark">Distribución por rubros</h3>
                    <p class="text-muted small mb-0">Análisis porcentual por categorías</p>
                </header>

                <div class="d-flex flex-column align-items-center gap-4">
                    <!-- Donut Chart via conic-gradient -->
                    <div class="position-relative flex-shrink-0" style="width: 160px; height: 160px;">
                        @if (DoughnutSegments.Any())
                        {
                            <div style="width: 100%; height: 100%; border-radius: 50%; background: @CategoryGradient;" role="img" aria-label="Distribución de rubros"></div>
                            <div class="position-absolute top-50 start-50 translate-middle bg-white rounded-circle shadow-sm d-flex flex-column align-items-center justify-content-center" style="width: 58%; height: 58%;">
                                <span class="fw-bold h4 mb-0">@CategoryReportData.Sum(x => x.Count)</span>
                                <span class="text-muted" style="font-size: 0.6rem; text-uppercase; letter-spacing: 0.5px;">Órdenes</span>
                            </div>
                        }
                        else
                        {
                            <div style="width: 100%; height: 100%; border-radius: 50%; background: #f8f9fa;"></div>
                        }
                    </div>

                    <!-- Legend -->
                    <div class="w-100 mt-2 overflow-auto" style="max-height: 200px;">
                        @foreach (var segment in DoughnutSegments)
                        {
                            <div class="d-flex align-items-center justify-content-between mb-2 pb-2 border-bottom border-light last-border-0">
                                <div class="d-flex align-items-center gap-2 overflow-hidden">
                                    <span class="d-inline-block rounded-circle flex-shrink-0" style="width: 12px; height: 12px; background-color: @segment.Color;"></span>
                                    <span class="small fw-medium text-truncate">@segment.Label</span>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="small fw-bold text-dark">@segment.Percentage.ToString("0.0")%</span>
                                    <span class="badge bg-light text-muted fw-normal" style="font-size: 0.65rem;">@segment.Count</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </article>*@
    </div> 
    
    <!-- Status Progress -->
    <article class="surface-card p-4 shadow-sm border-0 mb-2">
        <header class="mb-4">
            <h3 class="h6 mb-1 fw-bold text-dark">Cumplimiento de objetivos</h3>
            <p class="text-muted small mb-0">Estado operativo de las órdenes del sistema</p>
        </header>

        <div class="row g-4">
            @foreach (var item in StatusReportData)
            {
                var colors = new Dictionary<string, string> {
                    { "Pendiente", "#ffc107" },
                    { "Confirmado", "#198754" },
                    { "En curso", "#0dcaf0" },
                    { "Completado", "#0d6efd" },
                    { "Cancelado", "#dc3545" }
                };
                var color = colors.GetValueOrDefault(item.Label, "#6c757d");
                var percentage = StatusMax > 0 ? (double)item.Count * 100 / StatusMax : 0;

                <div class="col-md-6 col-lg-4">
                    <div class="p-3 border rounded-3 bg-light-subtle">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold">@item.Label</span>
                            <span class="text-muted fw-bold small">@item.Count</span>
                        </div>
                        <div class="progress" style="height: 6px;" role="progressbar" aria-valuenow="@((int)percentage)" aria-valuemin="0" aria-valuemax="100">
                            <div class="progress-bar" style="width: @percentage.ToString(CultureInfo.InvariantCulture)%; background-color: @color; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </article>
</section>

<style>
    .admin-reports .stat-card {
        border-radius: 16px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .admin-reports .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.05) !important;
    }
    .admin-reports .ls-wide { letter-spacing: 0.05em; }
    .admin-reports .last-border-0:last-child { border-bottom: 0 !important; }
    .admin-reports .bar-chart-card { border-radius: 20px; }
</style>

@code {
    [Parameter] public IEnumerable<GetCategory> Categories { get; set; } = Enumerable.Empty<GetCategory>();
    [Parameter] public List<AdminMetric> SummaryMetrics { get; set; } = new();
    [Parameter] public List<ServiceTransaction> Transactions { get; set; } = new();
    [Parameter] public IEnumerable<ReportBar> CategoryReportData { get; set; } = Enumerable.Empty<ReportBar>();
    [Parameter] public IEnumerable<ReportBar> StatusReportData { get; set; } = Enumerable.Empty<ReportBar>();
    [Parameter] public int CategoryMax { get; set; }
    [Parameter] public int StatusMax { get; set; }

    private string SelectedPeriod { get; set; } = "30";

    private (string Icon, string Color) GetMetricConfig(string label) => label switch
    {
        "Servicios Activos" => ("fa-bullhorn", "#198754"),
        "Nuevas Solicitudes" => ("fa-cart-plus", "#0d6efd"),
        "En Curso" => ("fa-spinner", "#0dcaf0"),
        "Nuevos Profesionales" => ("fa-user-tie", "#6610f2"),
        _ => ("fa-chart-line", "#6c757d")
    };

    // Chart Logic: Doughnut
    private List<DoughnutSegment> DoughnutSegments
    {
        get
        {
            var total = CategoryReportData.Sum(x => x.Count);
            if (total == 0) return new List<DoughnutSegment>();

            var segments = new List<DoughnutSegment>();
            var colors = new[] { "#0d6efd", "#198754", "#ffc107", "#dc3545", "#6c757d", "#6610f2", "#fd7e14" };
            var dataList = CategoryReportData.ToList();

            for (int i = 0; i < dataList.Count; i++)
            {
                var percentage = (double)dataList[i].Count / total * 100;
                segments.Add(new DoughnutSegment(
                    dataList[i].Label,
                    dataList[i].Count,
                    percentage,
                    colors[i % colors.Length]
                ));
            }
            return segments;
        }
    }

    private string CategoryGradient
    {
        get
        {
            var segments = DoughnutSegments;
            if (!segments.Any()) return "#f8f9fa";
            
            var parts = new List<string>();
            double cum = 0;
            foreach (var s in segments)
            {
                parts.Add($"{s.Color} {cum.ToString("0.00", CultureInfo.InvariantCulture)}% {(cum + s.Percentage).ToString("0.00", CultureInfo.InvariantCulture)}%");
                cum += s.Percentage;
            }
            return $"conic-gradient({string.Join(", ", parts)})";
        }
    }

    private record DoughnutSegment(string Label, int Count, double Percentage, string Color);

    // Dynamic Trend Data
    private List<(string Label, int Value)> TrendData => 
        Transactions.Any() 
            ? Transactions
                .GroupBy(t => t.Date.ToString("MMM", new CultureInfo("es-ES")))
                .OrderBy(g => g.Min(t => t.Date))
                .Select(g => (Label: char.ToUpper(g.Key[0]) + g.Key.Substring(1), Value: g.Count()))
                .ToList()
            : new() { ("Sin datos", 0) };

    private string TrendLinePath
    {
        get
        {
            var data = TrendData;
            if (data.Count < 2) return "M 0 45 L 100 45";
            
            var maxCount = data.Max(x => x.Value);
            var chartMax = maxCount > 0 ? maxCount * 1.2 : 10;
            var points = new List<string>();
            decimal stepX = 100m / (data.Count - 1);

            for (int i = 0; i < data.Count; i++)
            {
                var x = i * stepX;
                var y = 50 - ((decimal)data[i].Value / (decimal)chartMax * 40) - 5;
                points.Add(i == 0 ? "M" : "L");
                points.Add($"{x.ToString(CultureInfo.InvariantCulture)} {y.ToString(CultureInfo.InvariantCulture)}");
            }
            return string.Join(" ", points);
        }
    }

    private string TrendAreaPath => TrendData.Count >= 2 ? $"{TrendLinePath} L 100 50 L 0 50 Z" : "M 0 50 L 100 50 Z";

    private List<(string X, string Y)> TrendDots
    {
        get
        {
            var data = TrendData;
            if (data.Count < 1) return new();
            
            var maxCount = data.Max(x => x.Value);
            var chartMax = maxCount > 0 ? maxCount * 1.2 : 10;
            var dots = new List<(string, string)>();
            decimal stepX = data.Count > 1 ? 100m / (data.Count - 1) : 0;

            for (int i = 0; i < data.Count; i++)
            {
                var x = i * stepX;
                var y = 50 - ((decimal)data[i].Value / (decimal)chartMax * 40) - 5;
                dots.Add((x.ToString(CultureInfo.InvariantCulture), y.ToString(CultureInfo.InvariantCulture)));
            }
            return dots;
        }
    }
}
