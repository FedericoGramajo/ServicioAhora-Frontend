@attribute [Route(RouteConstants.Profile)]
@using System.Collections.Generic
@using ClientLibrary.Models.Address
@using ClientLibrary.Models
@using ClientLibrary.Services.Contracts
@inject IJSRuntime js
@inject AuthenticationStateProvider AuthStateProvider
@inject IAddressService addressService
@inject IAuthenticationService AuthenticationService

<PageTitle>Mi perfil - ServicioAhora!</PageTitle>

<div class="landing-page">

    <main class="container py-5 account-layout">
        <div class="d-flex flex-column gap-4">
            <div class="surface-card flex-grow-1">
                <div class="section-heading flex-column flex-lg-row">
                    <div>
                        <p class="text-uppercase text-muted small mb-1">Datos personales</p>
                        <h2 class="mb-0">Gestioná tu perfil</h2>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" @onclick="OpenUpdateModal">
                            <i class="fa-solid fa-user-pen me-2"></i>Editar Perfil
                        </button>
                    </div>
                </div>

                <div class="row g-3">
                    <!-- Profile Picture Section -->
                    <div class="col-12 mb-3">
                        <div class="d-flex align-items-center gap-3">
                            <div class="position-relative" style="width: 100px; height: 100px;">
                                @if (!string.IsNullOrEmpty(UserProfile.ProfileImage))
                                {
                                    <img src="@UserProfile.ProfileImage" class="rounded-circle w-100 h-100 object-fit-cover border" alt="Foto de perfil" />
                                }
                                else
                                {
                                    <div class="rounded-circle w-100 h-100 bg-light d-flex align-items-center justify-content-center border">
                                        <i class="fa-regular fa-user fa-3x text-muted"></i>
                                    </div>
                                }
                            </div>
                            <div>
                                <h5 class="mb-1">Foto de perfil</h5>
                                <p class="text-muted small mb-0">Esta es tu imagen actual registrada.</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Nombre completo</label>
                        <div class="form-control bg-light">@UserProfile.FullName</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Correo electrónico</label>
                        <div class="form-control bg-light">@UserProfile.Email</div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">Teléfono</label>
                        <div class="form-control bg-light">@(string.IsNullOrEmpty(UserProfile.PhoneNumber) ? "-" : UserProfile.PhoneNumber)</div>
                    </div>
                    
                    <div class="col-12 mt-4">
                        <label class="form-label fw-semibold d-block mb-2">Direcciones guardadas</label>
                        @if (isLoadingAddresses)
                        {
                            <div class="text-center p-3">
                                <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                <span class="ms-2 small text-muted">Cargando direcciones...</span>
                            </div>
                        }
                        else if (!Addresses.Any())
                        {
                            <p class="text-muted small">No tenés direcciones guardadas.</p>
                        }
                        else
                        {
                            @foreach (var address in Addresses)
                            {
                                <div class="card mb-2 border-0 shadow-sm">
                                    <div class="card-body d-flex justify-content-between align-items-center py-2">
                                        <div class="cursor-pointer flex-grow-1" @onclick="() => EditAddress(address)">
                                            <i class="fa-solid fa-map-pin text-primary me-2"></i>
                                            <span class="fw-medium">@address.Type:</span>
                                            <span>@address.Street @address.Number</span>
                                            @if (address.IsMain)
                                            {
                                                <span class="badge bg-success-subtle text-success ms-2">Principal</span>
                                            }
                                        </div>
                                        <div class="d-flex gap-1">
                                            <button class="btn btn-sm btn-outline-primary border-0" @onclick="() => EditAddress(address)">
                                                <i class="fa-solid fa-pen-to-square"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger border-0" @onclick="() => ConfirmDeleteAddress(address)">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        <button class="btn btn-outline-primary btn-sm mt-1" @onclick="ShowAddAddressModal">
                            <i class="fa-solid fa-plus me-1"></i> Agregar dirección
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para Editar Perfil -->
    @if (showUpdateModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title fw-bold text-primary">Actualizar Perfil</h5>
                        <button type="button" class="btn-close" @onclick="CloseUpdateModal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="text-center mb-4">
                            <div class="position-relative d-inline-block" style="width: 120px; height: 120px;">
                                @if (!string.IsNullOrEmpty(EditModel.ProfileImage))
                                {
                                    <img src="@EditModel.ProfileImage" class="rounded-circle w-100 h-100 object-fit-cover border shadow-sm" alt="Preview" />
                                }
                                else
                                {
                                    <div class="rounded-circle w-100 h-100 bg-light d-flex align-items-center justify-content-center border shadow-sm">
                                        <i class="fa-regular fa-user fa-3x text-muted"></i>
                                    </div>
                                }
                                <label for="profileUploadEdit" class="position-absolute bottom-0 end-0 btn btn-primary rounded-circle p-0 d-flex align-items-center justify-content-center border-white border-2" style="width: 36px; height: 36px; cursor: pointer;">
                                    <i class="fa-solid fa-camera fa-sm"></i>
                                </label>
                                <InputFile OnChange="OnInputFileChange" id="profileUploadEdit" class="d-none" accept=".jpg, .jpeg, .png" />
                            </div>
                            <p class="text-muted small mt-2">Personalizá tu imagen</p>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">Nombre completo</label>
                            <input type="text" class="form-control" @bind="EditModel.FullName" placeholder="Tu nombre" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Teléfono</label>
                            <input type="tel" class="form-control" @bind="EditModel.PhoneNumber" placeholder="11 4444 9999" />
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary px-4" @onclick="CloseUpdateModal">Cancelar</button>
                        <button type="button" class="btn btn-primary px-4" @onclick="UpdateProfile" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar cambios</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Modal para Nueva/Editar Dirección -->
    @if (showAddressModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-light text-primary">
                        <h5 class="modal-title fw-bold">@(currentAddress.Id == Guid.Empty ? "Nueva dirección" : "Editar dirección")</h5>
                        <button type="button" class="btn-close" @onclick="CloseAddressModal"></button>
                    </div>
                    <EditForm Model="currentAddress" OnValidSubmit="SaveAddress">
                        <div class="modal-body p-4">
                            <div class="row g-3">
                                <div class="col-8">
                                    <label class="form-label fw-semibold">Calle</label>
                                    <InputText class="form-control" @bind-Value="currentAddress.Street" placeholder="Ej. Av. Pellegrini" required />
                                </div>
                                <div class="col-4">
                                    <label class="form-label fw-semibold">Número</label>
                                    <InputText class="form-control" @bind-Value="currentAddress.Number" placeholder="123" required />
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Tipo (Etiqueta)</label>
                                    <InputSelect class="form-select" @bind-Value="currentAddress.Type">
                                        <option value="Casa">Casa</option>
                                        <option value="Trabajo">Trabajo</option>
                                        <option value="Otro">Otro</option>
                                    </InputSelect>
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch mt-2">
                                        <InputCheckbox class="form-check-input" @bind-Value="currentAddress.IsMain" id="isMainCheck" />
                                        <label class="form-check-label" for="isMainCheck">
                                            Establecer como principal
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer bg-light">
                            <button type="button" class="btn btn-secondary px-4" @onclick="CloseAddressModal">Cancelar</button>
                            <button type="submit" class="btn btn-primary px-4" disabled="@isSubmittingAddress">
                                @if (isSubmittingAddress)
                                {
                                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                    <span>Guardando...</span>
                                }
                                else
                                {
                                    <span>Guardar</span>
                                }
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    }

</div>

@code {
    private UserDto UserProfile { get; set; } = new();
    private UserUpdate EditModel { get; set; } = new();

    private bool showUpdateModal = false;
    private bool isSubmitting = false;

    private List<GetAddres> Addresses = new();
    private bool isLoadingAddresses = true;
    private bool showAddressModal = false;
    private bool isSubmittingAddress = false;
    private UpdateAddress currentAddress = new();
    private string userId = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value 
                 ?? authState.User.FindFirst("nameid")?.Value 
                 ?? string.Empty;

        await LoadProfile();
        await LoadAddresses();
    }

    private async Task LoadProfile()
    {
        UserProfile = await AuthenticationService.GetMyProfile();
    }

    private async Task LoadAddresses()
    {
        if (string.IsNullOrEmpty(userId)) return;
        
        isLoadingAddresses = true;
        try
        {
            var response = await addressService.GetAddressesAsync(userId);
            if (response != null && response.success && response.Data != null)
            {
                Addresses = response.Data.ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading addresses: {ex.Message}");
        }
        finally
        {
            isLoadingAddresses = false;
        }
    }

    private void OpenUpdateModal()
    {
        EditModel = new UserUpdate
        {
            Id = UserProfile.Id,
            FullName = UserProfile.FullName,
            PhoneNumber = UserProfile.PhoneNumber ?? "",
            ProfileImage = UserProfile.ProfileImage
        };
        showUpdateModal = true;
    }

    private void CloseUpdateModal()
    {
        showUpdateModal = false;
    }

    private async Task UpdateProfile()
    {
        if (string.IsNullOrWhiteSpace(EditModel.FullName))
        {
            await js.ToastrError("El nombre es obligatorio");
            return;
        }

        isSubmitting = true;
        try
        {
            var response = await AuthenticationService.UpdateUser(EditModel);
            if (response.success)
            {
                await LoadProfile();
                showUpdateModal = false;
                await js.ToastrSuccess("Perfil actualizado correctamente");
            }
            else
            {
                await js.ToastrError(response.Message);
            }
        }
        catch (Exception ex)
        {
            await js.ToastrError("Error inesperado al actualizar el perfil");
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                var resizedFile = await file.RequestImageFileAsync(file.ContentType, 300, 300);
                var buffer = new byte[resizedFile.Size];
                await resizedFile.OpenReadStream(1024 * 1024 * 5).ReadAsync(buffer);
                var base64 = Convert.ToBase64String(buffer);
                EditModel.ProfileImage = $"data:{file.ContentType};base64,{base64}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error uploading image: {ex.Message}");
        }
    }

    private void ShowAddAddressModal()
    {
        currentAddress = new UpdateAddress { Type = "Casa" };
        showAddressModal = true;
    }

    private void EditAddress(GetAddres address)
    {
        // Clone for editing using the UpdateAddress model which includes Id
        currentAddress = new UpdateAddress
        {
            Id = address.Id,
            Street = address.Street,
            Number = address.Number,
            Type = address.Type,
            IsMain = address.IsMain
        };
        showAddressModal = true;
    }

    private void CloseAddressModal()
    {
        showAddressModal = false;
    }

    private async Task SaveAddress()
    {
        if (string.IsNullOrWhiteSpace(currentAddress.Street) || string.IsNullOrWhiteSpace(currentAddress.Number))
        {
            await js.ToastrWarning("Calle y número son obligatorios");
            return;
        }

        isSubmittingAddress = true;
        try
        {
            ServiceResponse result;
            if (currentAddress.Id == Guid.Empty)
            {
                var createModel = new CreateAddres
                {
                    Street = currentAddress.Street,
                    Number = currentAddress.Number,
                    Type = currentAddress.Type,
                    IsMain = currentAddress.IsMain
                };
                result = await addressService.AddAddressAsync(createModel);
            }
            else
            {
                result = await addressService.UpdateAddressAsync(currentAddress);
            }

            if (result.success)
            {
                await LoadAddresses();
                showAddressModal = false;
                await js.ToastrSuccess("Dirección guardada correctamente");
            }
            else
            {
                await js.ToastrError(result.Message);
            }
        }
        catch (Exception ex)
        {
            await js.ToastrError("Error al guardar la dirección");
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isSubmittingAddress = false;
        }
    }

    private async Task ConfirmDeleteAddress(GetAddres address)
    {
        // Simple confirm using JS Interop
        var confirmed = await js.Confirm("¿Estás seguro de eliminar esta dirección?");
        if (confirmed)
        {
            var result = await addressService.DeleteAddressAsync(address.Id);
            if (result.success)
            {
                await LoadAddresses();
                await js.ToastrSuccess("Dirección eliminada");
            }
            else
            {
                await js.ToastrError(result.Message);
            }
        }
    }
}

