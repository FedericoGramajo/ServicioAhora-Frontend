@attribute [Route(RouteConstants.ProfessionalDashboard)]
@inject IProfessionalDashboardService DashboardService

<PageTitle>Panel profesional - ServicioAhora!</PageTitle>

<div class="landing-page">


    <main class="container py-5 account-layout">
        <div class="section-heading flex-column flex-lg-row">
            <div>
                <p class="text-uppercase text-muted small mb-1">Panel profesional</p>
                <h2 class="mb-0">Gestioná tus servicios y reportes</h2>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" @onclick="() => ServiceManagerComponent.OpenAddServiceModal(null)">Agregar servicio</button>
                <button class="btn btn-primary">Exportar reporte</button>
            </div>
        </div>

        <DashboardMetrics Metrics="@Metrics" />

        <CategoryManager MyCategories="@MyCategories" AvailableCategories="@AvailableCategories" OnCategoryChanged="@RefreshCategories" />

        <div class="row g-3 mb-4">
            <div class="col-12">
                <CertificationsList />
            </div>
        </div>

        <ServiceManager @ref="ServiceManagerComponent" ServiceGroups="@ServiceGroups" OnServiceChanged="@RefreshServices" />

        <div class="surface-card mt-4">
             <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h4 class="mb-1">Disponibilidad Horaria</h4>
                    <p class="text-muted mb-0">Configurá tus días y horarios de atención</p>
                </div>
            </div>
            
            <AvailabilitySchedule Availabilities="@Availabilities" OnAvailabilityChanged="@RefreshAvailability" />
        </div>

        <FinancialReports />
    </main>




</div>

@using Microsoft.JSInterop
@using ClientLibrary.Helper
@inject IJSRuntime JS

@code {
    private readonly CultureInfo LocalCulture = new("es-AR");

    // Data
    private ServiceManager ServiceManagerComponent;
    private ClientLibrary.Models.Landing.DashboardMetrics Metrics { get; set; } = new(0, 0, 0, 0);
    private List<ServiceGroup> ServiceGroups { get; set; } = new();
    private List<string> MyCategories { get; set; } = new();
    private List<string> AvailableCategories { get; set; } = new();
    private List<ProfessionalAvailability> Availabilities { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        await LoadMetricsAsync();
        await LoadServicesAsync();
        await LoadCategoriesAsync();
        await LoadAvailabilityAsync();
    }

    private async Task LoadMetricsAsync()
    {
        Metrics = await DashboardService.GetDashboardMetricsAsync();
    }

    private async Task LoadServicesAsync()
    {
        ServiceGroups = await DashboardService.GetServiceGroupsAsync();
    }

    private async Task LoadCategoriesAsync()
    {
        MyCategories = await DashboardService.GetMyCategoriesAsync();
        AvailableCategories = await DashboardService.GetAvailableCategoriesAsync();
    }

    private async Task LoadAvailabilityAsync()
    {
        Availabilities = await DashboardService.GetAvailabilityAsync();
    }

    // Callbacks
    private async Task RefreshServices()
    {
        await LoadServicesAsync();
        await LoadMetricsAsync(); // Updating services changes metrics
    }

    private async Task RefreshCategories()
    {
        await LoadCategoriesAsync();
        // If category removed, services might change? 
        // Logic says removing category removes services? 
        // User didn't specify cascade delete logic, but let's refresh services just in case.
        await LoadServicesAsync(); 
    }

    private async Task RefreshAvailability()
    {
        await LoadAvailabilityAsync();
    }
}
