@attribute [Route(RouteConstants.ClientDashboard)]
@attribute [Authorize(Roles = Constant.Administration.CustomerRole)]
@using ClientLibrary.Models.Landing
@using BlazorWasm.Shared.Client
@using ClientLibrary.Services
@using ClientLibrary.Services.Contracts
@inject IBookingService BookingService
@inject IHttpClientHelper HttpClientHelper

<PageTitle>Mi Actividad - ServicioAhora!</PageTitle>

<div class="landing-page">
    <main class="container py-5 account-layout">
        <!-- Header -->
        <div class="section-heading flex-column flex-lg-row mb-4">
            <div>
                <p class="text-uppercase text-muted small mb-1">Mi Actividad</p>
                <h2 class="fw-bold text-dark">Panel de Control</h2>
            </div>
            <div class="d-flex gap-2">
                <a class="btn btn-primary" href="@RouteConstants.Search">Buscar servicios</a>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="row g-3 mb-4">
                <div class="col-lg-2 col-md-4 col-6"><LoadingSkeleton Height="80" /></div>
                <div class="col-lg-2 col-md-4 col-6"><LoadingSkeleton Height="80" /></div>
                <div class="col-lg-2 col-md-4 col-6"><LoadingSkeleton Height="80" /></div>
                <div class="col-lg-2 col-md-4 col-6"><LoadingSkeleton Height="80" /></div>
                <div class="col-lg-2 col-md-4 col-6"><LoadingSkeleton Height="80" /></div>
                <div class="col-lg-2 col-md-4 col-6"><LoadingSkeleton Height="80" /></div>
            </div>
            <LoadingSkeleton Height="500" />
        }
        else
        {
            <!-- Metrics -->
            <ClientMetrics TotalInvested="@TotalInvested"
                           UpcomingCount="@UpcomingCount" 
                           ConfirmedCount="@ConfirmedCount"
                           InProgressCount="@InProgressCount" 
                           CompletedCount="@CompletedCount"
                           CancelledCount="@CancelledCount" />

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs mb-4">
                <li class="nav-item">
                    <button class="nav-link @(ActiveTab == "activity" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "activity"'>
                        <i class="fa-solid fa-list-check me-2"></i>Actividad
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link @(ActiveTab == "reports" ? "active fw-bold" : "")" @onclick='() => ActiveTab = "reports"'>
                        <i class="fa-solid fa-chart-pie me-2"></i>Reportes
                    </button>
                </li>
            </ul>

            <!-- Content -->
            @if (ActiveTab == "activity")
            {
                <ClientServiceHistory History="History" OnRatingClick="ShowRatingModal" />
            }
            else if (ActiveTab == "reports")
            {
                <CustomerAdvancedReports />
            }
        }
    </main>
</div>

<RatingModal @ref="ratingModal" OnRatingSubmitted="LoadDataAsync" />

@code {
    private string ActiveTab { get; set; } = "activity";
    private bool isLoading = true;
    private RatingModal ratingModal;

    private void ShowRatingModal((Guid serviceId, string? professionalName) data)
    {
        ratingModal.Show(data.serviceId, data.professionalName);
    }

    // Data State
    private List<ServiceHistoryItem> History { get; set; } = new();

    // Metrics Calculation
    private decimal TotalInvested => History
        .Where(h => h.Status.ToLower().Contains("completado") || h.Status.ToLower().Contains("finalizado") || h.Status.ToLower().Contains("completed") || h.Status.ToLower().Contains("finished"))
        .Sum(h => h.Total);

    private int UpcomingCount => History.Count(h => h.Status.ToLower() == "pending" || h.Status.ToLower() == "pendiente");
    
    private int ConfirmedCount => History.Count(h => h.Status.ToLower() == "confirmed" || h.Status.ToLower() == "confirmado" || h.Status.ToLower() == "confirmada");

    private int InProgressCount => History.Count(h => h.Status.ToLower().Contains("inprogress") || h.Status.ToLower().Contains("en curso"));

    private int CompletedCount => History.Count(h => h.Status.ToLower().Contains("completed") || h.Status.ToLower().Contains("completado") || h.Status.ToLower().Contains("finalizado"));

    private int CancelledCount => History.Count(h => h.Status.ToLower().Contains("canceled") || h.Status.ToLower().Contains("cancelado"));


    [Parameter]
    [SupplyParameterFromQuery]
    public string? Tab { get; set; }

    protected override async Task OnInitializedAsync()
    {
        ActiveTab = "activity";
        if (!string.IsNullOrEmpty(Tab))
        {
            ActiveTab = Tab.ToLower() switch
            {
                "reports" => "reports",
                _ => "activity"
            };
        }
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        isLoading = true;
        try 
        {
            var userId = await HttpClientHelper.GetUserIdAsync();
            if (!string.IsNullOrEmpty(userId))
            {
                var bookings = await BookingService.GetCustomerBookingsAsync(userId);
                History = bookings.Select(b => new ServiceHistoryItem(
                    b.ServiceId,
                    b.ServiceName,
                    b.CategoryName,
                    b.ProfessionalName,
                    b.Date,
                    b.Status,
                    b.TotalAmount,
                    b.IsRated
                )).ToList();
            }
        } 
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
