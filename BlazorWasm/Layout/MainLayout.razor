@inherits LayoutComponentBase
@using ClientLibrary.Helper
@using ClientLibrary.Models.Landing
@using BlazorWasm.Shared.Landing
@using System.Globalization

<div class="landing-page">
    <LandingHeader HeaderId="main-layout"
                   Brand="ServicioAhora!"
                   BrandHref="@RouteConstants.Home"
                   Search="@SearchBar"
                   AccountLinks="@AccountLinks"
                   NavLinks="@PrimaryNavLinks"
                   UserName="@UserName"
                   UserInitial="@UserInitial" />

    <main>
        <CustomErrorBoundary>
            @Body
        </CustomErrorBoundary>
    </main>

    <LandingFooter FooterId="main-footer"
                   Brand="ServicioAhora!"
                   Description="Coordinamos servicios hogareños confiables con soporte humano y seguimiento en tiempo real."
                   ContactLines="@FooterContact"
                   LinkGroups="@FooterGroups"
                   CurrentYear="@CurrentYear" />
</div>

@code {
    [Inject]
    private AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    private readonly SearchConfig SearchBar = new("Buscar servicios hogareños en ServicioAhora!", "Buscar");

    private List<MenuActionModel> AccountLinks { get; set; } = new();
    private readonly IReadOnlyList<NavLinkModel> PrimaryNavLinks = MenuConstants.PrimaryNavLinks;
    
    private string UserName { get; set; } = string.Empty;
    private string UserInitial { get; set; } = string.Empty;

    private readonly IReadOnlyList<string> FooterContact = new List<string>
    {
        "Tel: +54 11 5555 1111",
        "Email: hola@servicioahora.com",
        "Horario: Lunes a domingo 8 a 22 h"
    };

    private readonly IReadOnlyList<FooterGroupModel> FooterGroups = new List<FooterGroupModel>
    {
        new("Explorá más", new []
        {
            new FooterLinkModel("Servicios", RouteConstants.Search),
            new FooterLinkModel("Profesionales", RouteConstants.Professionals),
            new FooterLinkModel("Contacto", RouteConstants.Contact)
        })
    };

    private int CurrentYear => DateTime.Now.Year;

    protected override async Task OnInitializedAsync()
    {
        await UpdateMenu();
        AuthStateProvider.AuthenticationStateChanged += async _ => await UpdateMenu();
    }

    private async Task UpdateMenu()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var links = new List<MenuActionModel>();

        if (user.Identity?.IsAuthenticated == true)
        {
            var fullName = user.Identity.Name;
            if (string.IsNullOrEmpty(fullName))
            {
                 fullName = user.FindFirst("unique_name")?.Value ?? user.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? "Usuario";
            }
            
            UserName = fullName.Split(' ')[0]; // First name
            UserInitial = !string.IsNullOrEmpty(UserName) ? UserName[0].ToString().ToUpper() : "U";

            links.Add(new("Mi perfil", RouteConstants.Profile));

            if (user.IsInRole(Constant.Administration.AdminRole))
            {
                links.Add(new("Panel administrador", RouteConstants.AdminDashboard));
            }

            if (user.IsInRole(Constant.Administration.ProfessionalRole))
            {
                links.Add(new("Panel profesional", RouteConstants.ProfessionalDashboard));
            }

            links.Add(new("Cerrar sesión", RouteConstants.Logout));
        }
        else
        {
            UserName = string.Empty;
            UserInitial = string.Empty;

            links.Add(new("Iniciar sesión", RouteConstants.Login));
            links.Add(new("Registrarse", RouteConstants.Register));
        }

        AccountLinks = links;
        StateHasChanged();
    }
}
